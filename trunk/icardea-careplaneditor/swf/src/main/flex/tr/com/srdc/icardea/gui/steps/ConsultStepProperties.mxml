<?xml version="1.0" encoding="utf-8"?>

<mx:TitleWindow width="1213" xmlns:mx="http://www.adobe.com/2006/mxml" title="Consult Step Properties"  height="522">
<mx:VBox xmlns="fr.kapit.skin.component.*"
         xmlns:groe_org="org.groe.html.*"
         xmlns:source = "tr.com.srdc.icardea.gui.variables.*" 
         buttonMode="true" borderColor="#DBD6D1" alpha="1.0" backgroundColor="#cccccc" horizontalAlign="left"
         verticalAlign="top" width="100%" height="100%"
         creationComplete="init()">
    <mx:Script>
		<![CDATA[
			import tr.com.srdc.icardea.model.variables.DataSource;
			import tr.com.srdc.icardea.model.variables.Concept;
			import tr.com.srdc.htmlEditor.WindowDesignMain;
			import tr.com.srdc.icardea.model.careplan.Script;
			import tr.com.srdc.icardea.gui.variables.VariableProperties;
			import tr.com.srdc.icardea.model.htmlEditor.HTML;
			import tr.com.srdc.icardea.gui.scriptEditor.ScriptEditor;
		
		import mx.controls.TextArea;
		import tr.com.srdc.icardea.model.variables.Variable;
		import com.googlecode.flexxb.FlexXBEngine;
		import tr.com.srdc.icardea.model.steps.ConsultStep;
		import mx.core.Application;
		import mx.controls.Alert;
		import mx.managers.PopUpManager;
		import mx.collections.ArrayCollection;
		import com.kapit.diagram.DiagramEvent;
        import com.kapit.diagram.view.DiagramView;
        import mx.core.UIComponent;

  		
        
        [Bindable]
        public var types:ArrayCollection=new ArrayCollection();
        [Bindable]
        public var consultStep:ConsultStep = new ConsultStep();
    	[Bindable]
 		public var consultVar:Variable;
 	    [Bindable]
        public var refinementScript:ScriptEditor;
        [Bindable]
        public var script:Script;
        
        private var dataSource:ArrayCollection = new ArrayCollection;
        
 	    private function init():void {
        	trace("consultStep.display.html.body: "+consultStep.display.html.body)
        }
                      
        public function popHtmlEditor():void {
        	var popup:WindowDesignMain = new WindowDesignMain;
        	popup.variablesList = consultStep.variable;
        	popup.display = consultStep.display;
        	popup.nextSteps = consultStep.nextStep;
        	trace("popup.display: "+popup.display)
        	PopUpManager.addPopUp(popup, Application.application as DisplayObject,true);
        	PopUpManager.centerPopUp(popup);
        }
        
        public function saveConsultChoices():void
        {	
        	this.consultStep.name = consultName.text;
        	this.consultStep.variable = myGrid.dataProvider as ArrayCollection;
        	this.consultStep.display = consultStep.display;
        
        	PopUpManager.removePopUp(this);
            parentApplication.enabled=true;
        }
        
        public function addVariable():void
        {	
         	consultVar = new Variable;
           	consultStep.variable.addItem(consultVar);
           	sources.selectedIndex = 0;
	        sourceStack.selectedIndex = 0;
	        variableStack.selectedIndex = 1;
        }
        
        public function editVariable():void
        {
        	for(var i:int = 0; i < consultStep.variable.length; i++){
        		if(myGrid.selectedItem != null)
        		{
	        		if(myGrid.selectedItem.name == consultStep.variable.getItemAt(i).name)
	        		{
	        			consultVar = consultStep.variable.getItemAt(i) as Variable;
	        			if(consultVar.concept.getItemAt(0).schemeID == "MDC_IDC"){
	        				sources.selectedIndex = 0;
	        				sourceStack.selectedIndex = 0;	        				
	        				var node:XML = ciedDS.selectedNode.descendants("node").(@label == consultVar.concept.getItemAt(0).name)[0];
							ciedDS.treeData.selectedNode = node;	        				
	        			}
	        			else {
	        				sources.selectedIndex = 1;
	        				sourceStack.selectedIndex = 1;	        				
	        				var node:XML = ciedDS.selectedNode.descendants("node").(@label == consultVar.concept.getItemAt(0).name)[0];
							ciedDS.treeData.selectedNode = node;	        				
	        			}
	        			variableStack.selectedIndex = 1;
	        		}
	        	}
        	}  
        	
        }
        public function deleteVariable():void
        {
        	
        	for(var i:int=0;i<consultStep.variable.length;i++)
        	{
        		if(myGrid.selectedItem == null)
        			Alert.show("Please select a parameter to delete", "No Parameter Selected");
        			
        		if(myGrid.selectedItem != null)
        		{
	        		if(myGrid.selectedItem.name==consultStep.variable.getItemAt(i).name && myGrid.selectedItem.type==consultStep.variable.getItemAt(i).type)
	        		{
	        			consultStep.variable.removeItemAt(i);
	        			Alert.show("Parameter is deleted successfully");
	        		}
	        	}
        	}	
        	
        }
        
        public function whichVariable():Variable{
        	var vrb:Variable = new Variable;
        	for(var i:int = 0; i < consultStep.variable.length; i++){
        		if(myGrid.selectedItem != null)
        		{
	        		if(myGrid.selectedItem.name==consultStep.variable.getItemAt(i).name && myGrid.selectedItem.type==consultStep.variable.getItemAt(i).type)
	        		{
	        			vrb=consultStep.variable.getItemAt(i) as Variable;
	        		}
	        	}
        	}  
        	return vrb;
        }
        public function writeScript():void
        {
        	refinementScript = new ScriptEditor;
        	refinementScript.sparent=this;
        	refinementScript.stepName="consultStep";
        	script = new Script;
        	refinementScript.script=script;
        	var refVar:Variable = whichVariable();
        	script.refineVar = refVar;
        	
        	PopUpManager.addPopUp(refinementScript, Application.application as DisplayObject,true);
            PopUpManager.centerPopUp(refinementScript);
        }
        private function cancelConsultStep():void{
        	PopUpManager.removePopUp(this);
        }
        
        private function saveVariableProperties():void
        {
        	consultVar.name = varName.text;
        	consultVar.type = "string"; //This value is fixed
        	//consultVar.refValue = refValue.text;
        	var dataConcept:Concept;
        	var dataSource:DataSource;
        	// TODO: Concept and data sources
        	if(consultVar.concept != null && consultVar.dataSource != null){
        		consultVar.concept.removeAll();
        		consultVar.dataSource.removeAll();
        	}
        	if(sources.selectedItem == "Cardiac Implantable Electronic Device(CIED)"){
        		dataConcept = new Concept;
        		dataConcept.code = ciedDS.selectedNode.@code;
        		dataConcept.name = ciedDS.selectedNode.@label;
        		dataConcept.schemeID = "MDC_IDC";
        		
        		dataSource = new DataSource;
        		dataSource.code = "C0581396";
        		dataSource.name = "Cardiac implant device";
        		dataSource.schemeID = "UMLS";
        		
        		consultVar.concept.addItem(dataConcept);       
        		consultVar.dataSource.addItem(dataSource); 		    		
        	}
        	else if(sources.selectedItem == "Electronic Health Record(EHR)"){
        		dataConcept = new Concept;
        		dataConcept.code = ehrphrDS.definedValues.myGrid.selectedItem.id;
        		dataConcept.name = ehrphrDS.definedValues.myGrid.selectedItem.name;
        		dataConcept.schemeID = ehrphrDS.definedValues.myGrid.selectedItem.code;
        		consultVar.concept.addItem(dataConcept);
        		       
        		dataSource = new DataSource;
        		dataSource.code = "C1562065";
        		dataSource.name = "Record of health event";
        		dataSource.schemeID = "UMLS"; 
        		consultVar.dataSource.addItem(dataSource);
        		
        		dataSource = new DataSource;
        		if(ehrphrDS.selectedNode.@label == "Problem"){
        			dataSource.code = "C0033213";        			
        		}        			
        		else if(ehrphrDS.selectedNode.@label == "Medication"){
        			dataSource.code = "C2598133";        			
        		}        			
        		else if(ehrphrDS.selectedNode.@label == "Imaging Result"){
        			dataSource.code = "C1254595";        					
        		}        			
        		else if(ehrphrDS.selectedNode.@label == "Procedure"){
        			dataSource.code = "C1948041";        			   
        		}        			
        		else if(ehrphrDS.selectedNode.@label == "Demograpics"){
        			dataSource.code = "C1704791";        			
        		}
        		
        		dataSource.name = ehrphrDS.selectedNode.@label;  
        		dataSource.schemeID = "UMLS"; 
        		consultVar.dataSource.addItem(dataSource);
        	}
        	else if(sources.selectedItem == "Personal Health Record(PHR)"){
        		dataConcept = new Concept;
        		dataConcept.code = ehrphrDS.definedValues.myGrid.selectedItem.id;
        		dataConcept.name = ehrphrDS.definedValues.myGrid.selectedItem.name;
        		dataConcept.schemeID = ehrphrDS.definedValues.myGrid.selectedItem.code;
        		consultVar.concept.addItem(dataConcept);
        		       
        		dataSource = new DataSource;
        		dataSource.code = "C1562065";
        		dataSource.name = "Record of health event";
        		dataSource.schemeID = "UMLS"; 
        		consultVar.dataSource.addItem(dataSource);
        		
        		dataSource = new DataSource;
        		if(ehrphrDS.selectedNode.@label == "Problem"){
        			dataSource.code = "C0033213";        			
        		}        			
        		else if(ehrphrDS.selectedNode.@label == "Medication"){
        			dataSource.code = "C2598133";        			
        		}        			
        		else if(ehrphrDS.selectedNode.@label == "Imaging Result"){
        			dataSource.code = "C1254595";        				
        		}        			
        		else if(ehrphrDS.selectedNode.@label == "Procedure"){
        			dataSource.code = "C1948041";        			
        		}        			
        		else if(ehrphrDS.selectedNode.@label == "Demograpics"){
        			dataSource.code = "C1704791";        			
        		}
        		dataSource.name = ehrphrDS.selectedNode.@label;          	
        		dataSource.schemeID = "UMLS"; 
        		consultVar.dataSource.addItem(dataSource);
        	}
        	
        	variableStack.selectedIndex = 0;
        }
        private function cancelVariableProperties():void{
        	variableStack.selectedIndex = 0;
        	
        }
        
        private function changeSourcesView():void{
        	if(sources.selectedItem == "Cardiac Implantable Electronic Device(CIED)"){
        		sourceStack.selectedIndex = 0;
        	}
        	else if(sources.selectedItem == "Electronic Health Record(EHR)"){
        		sourceStack.selectedIndex = 1;
        	}
        	else if(sources.selectedItem == "Personal Health Record(PHR)"){
        		sourceStack.selectedIndex = 1;
        	}
        }
        
        ]]>
	</mx:Script>
	 	<mx:ViewStack id="variableStack" width="1173" creationPolicy="all" height="468">
		 	<mx:VBox id="cont" width="100%" creationPolicy="all">
			    <mx:Spacer height="5%"/>
			    <mx:TextInput id="consultName" text="{this.consultStep.name}" width="100%" fontSize="12"/>
			    <mx:Spacer height="5%"/>
			    <mx:HBox>
			    	 <mx:Label text="Parameters to be retrieved from external systems while execution:" width="100%" fontSize="12" fontWeight="bold"/>
			    	 <mx:Spacer width="5%"/>
			    	 <mx:LinkButton toolTip="Add New Parameter" icon="@Embed('/assets/careplaneditor/add.png')" click="addVariable()" width="20" height="20"/>
			    </mx:HBox>		   
			    <mx:HBox height="100%" width="100%">
			    	<mx:DataGrid id="myGrid" width="100%" height="100%" dataProvider="{this.consultStep.variable}" >
			    	   	<mx:columns>
			    	   	   	<mx:DataGridColumn headerText="Name" dataField="name" />
			    	   	   	<mx:DataGridColumn headerText="Operations">
			    	   	    	<mx:itemRenderer>
									<mx:Component>
										<mx:HBox width="100%" horizontalAlign="center">
											<mx:LinkButton toolTip="Edit properties of this parameter" icon="@Embed('/assets/careplaneditor/edit.png')" click="outerDocument.editVariable()" width="20" height="20"/>
											<mx:LinkButton toolTip="Delete this parameter" icon="@Embed('/assets/careplaneditor/delete.png')" click="outerDocument.deleteVariable()" width="20" height="20"/>
											<mx:LinkButton toolTip="Mathematical operations with parameters" icon="@Embed('/assets/careplaneditor/scriptEditor/editor.png')" click="outerDocument.writeScript()" width="20" height="20"/>
										</mx:HBox>
									</mx:Component>
								</mx:itemRenderer>
							</mx:DataGridColumn>
			    	   	 </mx:columns> 
			    	  </mx:DataGrid>
			    </mx:HBox>
			    <mx:Spacer height="10%"/>
				<mx:HBox>
					<mx:Button icon="@Embed(source='/assets/careplaneditor/design.png')" label="Design Monitoring Window" enabled="true" click="{popHtmlEditor()}"  />
				</mx:HBox>
				<mx:Spacer height="10%"/>
				<mx:HBox horizontalAlign="right" width="100%">
			    	<mx:Button icon="@Embed(source='/assets/save.png')" label="Save" click="saveConsultChoices()" />
			    	<mx:Button icon="@Embed(source='/assets/cancel.png')" label="Cancel" click="cancelConsultStep()"/>
			    </mx:HBox>
			</mx:VBox>
			<mx:VBox width="100%" height="100%" >
		        <mx:Form width="100%">
		        	<mx:FormItem labelStyleName="myFormItemLabelStyle" label="Name:"  >
			         	<mx:TextInput id="varName" text="{consultVar.name}"/>
			         </mx:FormItem>
			         <mx:FormItem labelStyleName="myFormItemLabelStyle" label="Normal Value (Optional):" >
			         	<mx:TextInput id="refValue" text="{consultVar.refValue}" />
			         </mx:FormItem>
		        </mx:Form> 
		        <mx:Label text="From which system do you want to add this parameter?" fontSize="12"/>
		        <mx:ComboBox fontSize="12" change="changeSourcesView()" id="sources">
			    	<mx:ArrayCollection>
						<mx:String>Cardiac Implantable Electronic Device(CIED)</mx:String>
						<mx:String>Electronic Health Record(EHR)</mx:String>
						<mx:String>Personal Health Record(PHR)</mx:String>
					</mx:ArrayCollection>
		    	</mx:ComboBox>        	
		    	<mx:ViewStack id="sourceStack" width="100%" creationPolicy="all">
		    		<source:CIEDDataSources id="ciedDS" width="100%" />
		    		<source:EHRPHRDataSources id="ehrphrDS" width="100%" />
		    	</mx:ViewStack>
		    	<mx:HBox horizontalAlign="right" width="100%">
			    	<mx:Button icon="@Embed(source='/assets/save.png')" label="Save" click="saveVariableProperties()" />
			    	<mx:Button icon="@Embed(source='/assets/cancel.png')" label="Cancel" click="cancelVariableProperties()"/>
			    </mx:HBox>
			</mx:VBox>
		</mx:ViewStack>
	</mx:VBox>	
</mx:TitleWindow>

